<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Recipe Collection - UK Measurements</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      line-height: 1.6;
      color: #333;
      background-color: #f8f9fa;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .hero {
      position: relative;
      height: 400px;
      overflow: hidden;
      background-color: #655c4a;
    }

    .hero-image {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      /* opacity and object-position will be set via JavaScript */
    }

    header {
      position: relative;
      z-index: 1;
      color: white;
      padding: 2rem 0;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 2rem;
    }

    main {
      flex: 1;
    }

    h1 {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
    }

    .subtitle {
      font-size: 1.1rem;
      opacity: 0.9;
    }

    .header-actions {
      margin-top: 1.5rem;
    }

    .btn {
      display: inline-block;
      padding: 0.75rem 1.5rem;
      background-color: white;
      color: #655c4a;
      text-decoration: none;
      border-radius: 6px;
      font-weight: 600;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .search-bar {
      margin: 2rem 0;
      position: relative;
    }

    .search-bar input {
      width: 100%;
      padding: 1rem 1.5rem;
      font-size: 1rem;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      transition: border-color 0.3s;
    }

    .search-bar input:focus {
      outline: none;
      border-color: #655c4a;
    }

    .recipe-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 2rem;
      margin: 2rem 0;
    }

    @media (max-width: 1024px) {
      .recipe-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 640px) {
      .recipe-grid {
        grid-template-columns: 1fr;
      }
    }

    .recipe-card {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      transition: transform 0.3s, box-shadow 0.3s;
      cursor: pointer;
      display: grid;
      grid-template-rows: auto 1fr;
    }

    .recipe-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 24px rgba(0,0,0,0.15);
    }

    .recipe-card-header {
      padding: 1.5rem;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .recipe-card h3 {
      font-size: 1.4rem;
      color: #2d3748;
      margin-bottom: 0.5rem;
      line-height: 1.3;
    }

    .recipe-source {
      font-size: 0.9rem;
      color: #718096;
    }

    .recipe-card-body {
      padding: 1.5rem;
    }

    .recipe-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .meta-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
      color: #4a5568;
    }

    .meta-icon {
      font-size: 1.2rem;
    }

    .dietary-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .tag {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      background-color: #e6f3ff;
      color: #0066cc;
      border-radius: 12px;
      font-size: 0.85rem;
      font-weight: 500;
    }

    .loading {
      text-align: center;
      padding: 4rem 0;
      font-size: 1.2rem;
      color: #718096;
    }

    .error {
      background-color: #fff5f5;
      border: 1px solid #feb2b2;
      color: #c53030;
      padding: 1rem;
      border-radius: 8px;
      margin: 2rem 0;
    }

    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
    }

    .empty-state h2 {
      font-size: 1.8rem;
      color: #4a5568;
      margin-bottom: 1rem;
    }

    footer {
      background-color: #2d3748;
      color: white;
      text-align: center;
      padding: 2rem 0;
      margin-top: 4rem;
    }

    footer a {
      color: #655c4a;
      text-decoration: none;
    }

    footer a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="hero">
    <img id="heroImage" class="hero-image" alt="Hero background">
    <header>
      <div class="container">
        <h1>Recipe Collection</h1>
        <p class="subtitle">All recipes with UK measurements</p>
      </div>
    </header>
  </div>

  <main class="container">
    <div class="search-bar">
      <input
        type="text"
        id="searchInput"
        placeholder="Search recipes by name, source, or ingredients..."
        autocomplete="off"
      >
    </div>

    <div id="loadingState" class="loading">Loading recipes...</div>
    <div id="errorState" class="error" style="display: none;"></div>
    <div id="emptyState" class="empty-state" style="display: none;">
      <h2>No recipes yet</h2>
      <p>Start by <a href="/import" class="btn" style="margin-top: 1rem;">importing your first recipe</a></p>
    </div>
    <div id="recipeGrid" class="recipe-grid" style="display: none;"></div>
  </main>

  <footer>
    <div class="container">
      <p>&copy; 2025 Recipe Collection</p>
      <p style="margin-top: 0.5rem;"><a href="/import">Import New Recipe</a></p>
    </div>
  </footer>

  <script>
    let allRecipes = [];

    // Load and set hero image
    async function loadHeroImage() {
      try {
        // Fetch hero configuration
        const configResponse = await fetch('/hero-config.json');
        const config = await configResponse.json();

        if (!config.images || config.images.length === 0) {
          console.error('No hero images configured');
          return;
        }

        // Check if we have a stored image selection
        let storedConfigIndex = localStorage.getItem('heroImageIndex');
        let selectedConfig;

        if (storedConfigIndex !== null && config.images[storedConfigIndex]) {
          // Use stored image
          selectedConfig = config.images[storedConfigIndex];
        } else {
          // Select a random image
          const randomIndex = Math.floor(Math.random() * config.images.length);
          selectedConfig = config.images[randomIndex];
          // Store the index for next time
          localStorage.setItem('heroImageIndex', randomIndex);
        }

        // Apply the configuration
        const heroElement = document.querySelector('.hero');
        const heroImage = document.getElementById('heroImage');

        heroImage.src = `/images/${selectedConfig.filename}`;
        heroImage.style.opacity = selectedConfig.opacity || 0.4;
        heroImage.style.objectPosition = selectedConfig.objectPosition || 'center';
        heroElement.style.backgroundColor = selectedConfig.backgroundColor || '#667eea';

      } catch (error) {
        console.error('Error loading hero image:', error);
      }
    }

    async function loadRecipes() {
      try {
        const response = await fetch('/api/recipes');
        const data = await response.json();

        if (!response.ok) throw new Error(data.error || 'Failed to load recipes');

        allRecipes = data.recipes || [];
        displayRecipes(allRecipes);

        document.getElementById('loadingState').style.display = 'none';

        if (allRecipes.length === 0) {
          document.getElementById('emptyState').style.display = 'block';
        } else {
          document.getElementById('recipeGrid').style.display = 'grid';
        }
      } catch (error) {
        console.error('Error loading recipes:', error);
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('errorState').style.display = 'block';
        document.getElementById('errorState').textContent = 'Error loading recipes: ' + error.message;
      }
    }

    function displayRecipes(recipes) {
      const grid = document.getElementById('recipeGrid');
      grid.innerHTML = '';

      recipes.forEach(recipe => {
        const card = createRecipeCard(recipe);
        grid.appendChild(card);
      });

      // Equalize header heights after cards are rendered
      requestAnimationFrame(() => {
        equalizeHeaderHeights();
      });
    }

    function equalizeHeaderHeights() {
      const grid = document.getElementById('recipeGrid');
      const cards = Array.from(grid.querySelectorAll('.recipe-card'));

      if (cards.length === 0) return;

      // Reset all header heights first
      cards.forEach(card => {
        const header = card.querySelector('.recipe-card-header');
        if (header) header.style.height = 'auto';
      });

      // Get computed style to determine columns per row
      const gridStyle = window.getComputedStyle(grid);
      const gridCols = gridStyle.gridTemplateColumns.split(' ').length;

      // Process cards in rows
      for (let i = 0; i < cards.length; i += gridCols) {
        const rowCards = cards.slice(i, i + gridCols);
        const headers = rowCards.map(card => card.querySelector('.recipe-card-header')).filter(h => h);

        if (headers.length === 0) continue;

        // Find the tallest header in this row
        const maxHeight = Math.max(...headers.map(header => header.offsetHeight));

        // Set all headers in this row to the same height
        headers.forEach(header => {
          header.style.height = `${maxHeight}px`;
        });
      }
    }

    function createRecipeCard(recipe) {
      const card = document.createElement('div');
      card.className = 'recipe-card';
      card.onclick = () => window.location.href = `/recipes/${recipe.id}`;

      const metaItems = [];
      if (recipe.prep_time) metaItems.push(`<div class="meta-item"><span class="meta-icon">‚è±Ô∏è</span>${recipe.prep_time}</div>`);
      if (recipe.cook_time) metaItems.push(`<div class="meta-item"><span class="meta-icon">üî•</span>${recipe.cook_time}</div>`);
      if (recipe.servings) metaItems.push(`<div class="meta-item"><span class="meta-icon">üçΩÔ∏è</span>${recipe.servings} servings</div>`);

      const dietaryTags = recipe.dietary_info && Array.isArray(recipe.dietary_info)
        ? recipe.dietary_info.map(tag => `<span class="tag">${tag}</span>`).join('')
        : '';

      card.innerHTML = `
        <div class="recipe-card-header">
          <h3>${escapeHtml(recipe.name)}</h3>
          ${recipe.source ? `<p class="recipe-source">from ${escapeHtml(recipe.source)}</p>` : ''}
        </div>
        <div class="recipe-card-body">
          ${metaItems.length ? `<div class="recipe-meta">${metaItems.join('')}</div>` : ''}
          ${dietaryTags ? `<div class="dietary-tags">${dietaryTags}</div>` : ''}
        </div>
      `;

      return card;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Search functionality
    document.getElementById('searchInput').addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase();

      if (!searchTerm) {
        displayRecipes(allRecipes);
        return;
      }

      const filtered = allRecipes.filter(recipe => {
        const name = recipe.name?.toLowerCase() || '';
        const source = recipe.source?.toLowerCase() || '';
        const ingredients = JSON.stringify(recipe.ingredients || []).toLowerCase();

        return name.includes(searchTerm) ||
               source.includes(searchTerm) ||
               ingredients.includes(searchTerm);
      });

      displayRecipes(filtered);
    });

    // Recalculate header heights on window resize
    let resizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        equalizeHeaderHeights();
      }, 150);
    });

    // Load recipes and hero image on page load
    loadHeroImage();
    loadRecipes();
  </script>
</body>
</html>
